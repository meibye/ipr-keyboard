[Unit]
Description=IPR Keyboard Unified BlueZ Agent
After=bluetooth.service
Requires=bluetooth.service
BindsTo=bluetooth.service

[Service]
Type=simple
StandardOutput=journal
StandardError=journal
SyslogIdentifier=bt_hid_agent_unified
EnvironmentFile=-/opt/ipr_common.env
ExecStartPre=/bin/sh -c '/usr/bin/btmgmt -i "${BT_HCI:-hci0}" le on'
ExecStartPre=/bin/sh -c '/usr/bin/btmgmt -i "${BT_HCI:-hci0}" bredr off'
# ext-adv is not supported on all stacks; keep it best-effort to avoid hard failure
ExecStartPre=/bin/sh -c '/usr/bin/btmgmt -i "${BT_HCI:-hci0}" ext-adv off >/dev/null 2>&1 || true'
ExecStartPre=/bin/sh -c '/usr/bin/btmgmt -i "${BT_HCI:-hci0}" advertising on'
ExecStart=/usr/bin/python3 -u /usr/local/bin/bt_hid_agent_unified.py --mode nowinpasskey --capability NoInputNoOutput --adapter ${BT_HCI:-hci0}
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target bluetooth.service
